# 📐 aigroup-quant-mcp 项目架构说明

## 🎯 项目概览

**aigroup-quant-mcp** 是一个企业级的量化金融分析平台，参考微软Qlib架构设计，专注于提供完整的量化研究工具链。该项目于2025年开发，目前已发展到v2.0版本，具有高度模块化和可扩展的特性。

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    aigroup-quant-mcp                       │
├─────────────────────────────────────────────────────────────────┤
│  🚀 MCP服务层 (11个专业量化工具)                              │
├─────────────────────────────────────────────────────────────────┤
│  📦 核心业务层                                                  │
│  ├─ 🗃️ 数据层 (DataLoader, DataProcessor)                      │
│  ├─ 🔬 因子层 (FactorLibrary, Alpha158Generator)                │
│  ├─ 🤖 模型层 (LSTM, GRU, Transformer)                         │
│  └─ 📈 策略层 (BacktestEngine)                                  │
├─────────────────────────────────────────────────────────────────┤
│  🛠️ 基础设施层                                                  │
│  ├─ 🔧 工具库 (pandas, numpy, torch)                           │
│  ├─ 📊 可视化 (matplotlib)                                     │
│  └─ 🧪 测试框架 (pytest)                                        │
└─────────────────────────────────────────────────────────────────┘
```

## 📂 目录结构详解

### 项目根目录结构
```
aigroup-quant-mcp/
├── quantanalyzer/              # 🏢 核心业务包
│   ├── __init__.py
│   ├── mcp.py                  # 🚀 MCP服务器主入口
│   ├── data/                   # 🗃️ 数据管理模块
│   │   ├── loader.py          # 数据加载器
│   │   └── processor.py       # 数据预处理器
│   ├── factor/                 # 🔬 因子计算引擎
│   │   ├── library.py         # 基础因子库（6个因子）
│   │   ├── alpha158.py        # ⭐ Alpha158因子库（158个因子）
│   │   └── evaluator.py       # 因子评估器
│   ├── model/                  # 🤖 机器学习模型
│   │   ├── trainer.py         # 传统ML模型训练器
│   │   └── deep_models.py     # 深度学习模型（LSTM/GRU/Transformer）
│   ├── backtest/               # 📈 回测引擎
│   │   └── engine.py          # 策略回测引擎
│   ├── portfolio/              # 💼 组合管理（预留）
│   └── utils/                  # 🔧 工具函数（预留）
├── examples/                   # 💡 示例代码
├── tests/                      # 🧪 测试用例
├── docs/                       # 📚 文档
├── requirements.txt            # 📦 依赖清单
├── pyproject.toml             # ⚙️ 项目配置
├── setup.py                   # 📦 安装配置
└── README.md                  # 📖 项目说明
```

## 🎯 核心模块详解

### 1️⃣ 数据层 (Data Layer)

#### DataLoader (`quantanalyzer/data/loader.py`)
```python
class DataLoader:
    """多格式数据加载器"""
    
    def load_from_csv(file_path: str) -> pd.DataFrame:
        """加载CSV格式股票数据"""
        
    def load_from_dataframe(df: pd.DataFrame) -> pd.DataFrame:
        """从DataFrame加载数据"""
        
    def validate_data(data: pd.DataFrame) -> bool:
        """数据质量验证"""
```

**数据格式要求：**
- **索引**: MultiIndex (datetime, symbol)
- **列名**: open, high, low, close, volume（必需）
- **格式**: 数值型，无缺失值

#### DataProcessor (`quantanalyzer/data/processor.py`)
```python
class DataProcessor:
    """数据预处理工具链"""
    
    def fillna(data: pd.DataFrame) -> pd.DataFrame:
        """缺失值填充（前向填充）"""
        
    def normalize(data: pd.DataFrame, method: str) -> pd.DataFrame:
        """数据标准化（Z-score/MinMax）"""
        
    def winsorize(data: pd.DataFrame) -> pd.DataFrame:
        """极值处理"""
```

**支持的Processor类型：**
- `CSZScoreNorm` - 截面标准化
- `DropnaLabel` - 删除空标签
- `Fillna` - 填充缺失值
- `ZScoreNorm` - 时序标准化
- `RobustZScoreNorm` - 鲁棒标准化
- `MinMaxNorm` - 最小最大归一化
- `CSRankNorm` - 排名标准化

### 2️⃣ 因子层 (Factor Layer)

#### FactorLibrary (`quantanalyzer/factor/library.py`)
**6个基础量化因子：**
```python
class FactorLibrary:
    """经典量化因子库"""
    
    def momentum(data: pd.DataFrame, period: int) -> pd.Series:
        """动量因子 - 价格相对强弱"""
        
    def volatility(data: pd.DataFrame, period: int) -> pd.Series:
        """波动率因子 - 价格波动强度"""
        
    def volume_ratio(data: pd.DataFrame, period: int) -> pd.Series:
        """成交量比率因子 - 成交活跃度"""
        
    def rsi(data: pd.DataFrame, period: int) -> pd.Series:
        """RSI相对强弱指标"""
        
    def macd(data: pd.DataFrame) -> pd.Series:
        """MACD动量指标"""
        
    def bollinger_bands(data: pd.DataFrame, period: int) -> pd.Series:
        """布林带位置指标"""
```

#### Alpha158Generator (`quantanalyzer/factor/alpha158.py`)
**⭐ 核心特色 - 158个技术指标因子**
```python
class Alpha158Generator:
    """企业级因子生成引擎"""
    
    def __init__(data: pd.DataFrame):
        """支持OHLCV数据输入"""
        
    def generate_all(
        kbar: bool = True,      # K线形态（9个）
        price: bool = True,     # 价格因子（5个）
        volume: bool = True,    # 成交量因子（5个）
        rolling: bool = True,   # 滚动统计（139个）
        rolling_windows: List[int] = [5, 10, 20, 30, 60]
    ) -> pd.DataFrame:
        """生成完整因子集"""
```

**因子分类体系：**
| 类别 | 数量 | 代表因子 | 说明 |
|------|------|----------|------|
| **K线形态** | 9个 | KMID, KLEN, KUP | 蜡烛图技术形态 |
| **价格因子** | 5个 | OPEN0, HIGH0, LOW0 | 价格水平特征 |
| **成交量** | 5个 | VOLUME0-4 | 成交量特征 |
| **趋势类** | 30+ | ROC, MA, BETA | 趋势跟踪指标 |
| **波动类** | 10+ | STD, RESI | 波动率指标 |
| **极值类** | 20+ | MAX, MIN, QTLU | 极值统计指标 |
| **位置类** | 15+ | RANK, RSV, IMAX | 相对位置指标 |
| **相关类** | 10+ | CORR, CORD | 相关性指标 |
| **统计类** | 40+ | CNTP, SUMP, VMA | 统计特征指标 |

#### FactorEvaluator (`quantanalyzer/factor/evaluator.py`)
```python
class FactorEvaluator:
    """因子评估引擎"""
    
    def calculate_ic(method: str = 'spearman') -> Dict:
        """计算信息系数（IC）"""
        
    def calculate_icir() -> float:
        """计算信息比率（ICIR）"""
        
    def group_analysis() -> pd.DataFrame:
        """分组收益分析"""
```

### 3️⃣ 模型层 (Model Layer)

#### ModelTrainer (`quantanalyzer/model/trainer.py`)
**传统机器学习模型：**
```python
class ModelTrainer:
    """传统ML模型训练器"""
    
    def __init__(model_type: str):
        """支持LightGBM/XGBoost/Linear"""
        
    def fit(X_train, y_train) -> Dict:
        """模型训练与交叉验证"""
        
    def predict(X_test) -> pd.Series:
        """模型预测"""
```

#### 深度学习模型 (`quantanalyzer/model/deep_models.py`)
**⭐ 三种主流深度学习架构：**

**LSTMModel** - 长短期记忆网络
```python
class LSTMModel:
    """LSTM序列建模"""
    - hidden_size: 隐藏层维度
    - num_layers: LSTM层数
    - dropout: 正则化
    - early_stop: 早停机制
    - GPU加速支持
```

**GRUModel** - 门控循环单元
```python
class GRUModel(LSTMModel):
    """GRU高效序列学习"""
    - 参数更少，训练更快
    - 适合中小数据集
```

**TransformerModel** - 注意力机制
```python
class TransformerModel:
    """Transformer注意力模型"""
    - d_model: 模型维度
    - nhead: 注意力头数
    - 并行化计算
    - 适合大规模数据
```

### 4️⃣ 策略层 (Strategy Layer)

#### BacktestEngine (`quantanalyzer/backtest/engine.py`)
```python
class BacktestEngine:
    """专业回测引擎"""
    
    def __init__(
        data: pd.DataFrame,
        predictions: pd.Series,
        top_k: int,
        commission: float,
        slippage: float
    ):
        """回测参数配置"""
        
    def run() -> Dict:
        """执行回测并返回性能指标"""
```

**支持的性能指标：**
- **绝对收益**: 总收益率、年化收益率
- **风险指标**: 波动率、最大回撤、夏普比率
- **交易成本**: 手续费、冲击成本
- **风险调整**: 信息比率、胜率分析

## 🚀 MCP服务架构

### 服务架构设计
```
┌─────────────────────────────────────────────────────────┐
│                 MCP服务器 (11个工具)                   │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │           工具层 (Tool Layer)                   │    │
│  │  ┌─ load_csv_data       (数据加载)              │    │
│  │  ├─ calculate_factor    (因子计算)              │    │
│  │  ├─ generate_alpha158   (Alpha158生成)           │    │
│  │  ├─ evaluate_factor_ic  (因子评估)              │    │
│  │  ├─ train_lstm_model    (LSTM训练)              │    │
│  │  ├─ train_gru_model     (GRU训练)               │    │
│  │  ├─ train_transformer   (Transformer训练)        │    │
│  │  ├─ predict_with_model  (模型预测)              │    │
│  │  ├─ get_data_info       (数据信息)              │    │
│  │  ├─ list_factors        (因子列表)              │    │
│  │  └─ list_models         (模型列表)              │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │           服务层 (Service Layer)                │    │
│  │  ├─ 数据存储管理 (Data Store)                   │    │
│  │  ├─ 因子存储管理 (Factor Store)                 │    │
│  │  ├─ 模型存储管理 (Model Store)                  │    │
│  │  └─ Processor存储 (Processor Store)             │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │         业务逻辑层 (Business Logic)             │    │
│  │  ├─ QuantAnalyzer核心模块调用                   │    │
│  │  ├─ 数据格式转换与验证                         │    │
│  │  ├─ 错误处理与日志记录                         │    │
│  │  └─ 结果格式化与序列化                         │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 启动方式
```bash
# 方式1: uvx直接运行（推荐）
uvx aigroup-quant-mcp

# 方式2: Python模块运行
python -m quantanalyzer.mcp

# 方式3: 安装后运行
pip install aigroup-quant-mcp
aigroup-quant-mcp
```

## ⚙️ 技术架构特色

### 1️⃣ 模块化设计
- **高内聚，低耦合**: 各模块职责清晰，独立性强
- **标准化接口**: 统一的API设计模式
- **易于扩展**: 支持动态加载新因子和新模型

### 2️⃣ 数据流设计
```
原始数据 → 数据加载 → 数据预处理 → 因子计算 → 因子评估 → 模型训练 → 策略回测 → 性能分析
```

### 3️⃣ 存储架构
- **内存存储**: 高性能的in-memory数据管理
- **结构化存储**: 按类型分类存储（数据/因子/模型）
- **序列化支持**: JSON格式的结果输出

### 4️⃣ 错误处理
- **参数验证**: 严格的输入参数检查
- **异常捕获**: 完善的错误处理机制
- **友好提示**: 清晰的错误信息反馈

## 📊 项目特色亮点

### ⭐ 技术亮点

1. **Alpha158因子库**: 业界领先的158个技术指标完整实现
2. **三剑客深度学习**: LSTM、GRU、Transformer全面支持
3. **企业级MCP服务**: 11个专业量化工具的无缝集成
4. **灵活的Processor系统**: 7种数据预处理器的组合使用
5. **完整的工作流程**: 从数据到策略的端到端解决方案

### 🏆 架构优势

1. **轻量级设计**: 不依赖复杂的数据下载系统，专注核心功能
2. **高度可配置**: 支持多种参数配置和自定义扩展
3. **专业级性能**: 企业级的代码质量和性能优化
4. **易于集成**: 与Roo-Code等开发工具的无缝集成
5. **完整文档**: 详细的使用文档和示例代码

## 🔧 技术栈概览

| 层级 | 技术组件 | 版本要求 | 用途 |
|------|----------|----------|------|
| **核心框架** | Python | 3.8+ | 主编程语言 |
| **数据科学** | pandas | 2.0.0+ | 数据处理 |
| | numpy | 1.24.0+ | 数值计算 |
| | scipy | 1.10.0+ | 科学计算 |
| **机器学习** | lightgbm | 4.0.0+ | 梯度提升树 |
| | xgboost | 2.0.0+ | 极限梯度提升 |
| | scikit-learn | 1.3.0+ | 传统机器学习 |
| **深度学习** | torch | 2.0.0+ | 神经网络框架 |
| **服务通信** | mcp | 1.0.0+ | 模型上下文协议 |
| **可视化** | matplotlib | 3.7.0+ | 图表绘制 |
| **测试框架** | pytest | 7.4.0+ | 单元测试 |

## 🎯 使用场景

### 场景1: Alpha因子挖掘
```python
# 快速生成并评估158个因子
generator = Alpha158Generator(data)
factors = generator.generate_all()
# 自动化因子评估和筛选
```

### 场景2: 深度学习选股
```python
# 训练深度学习模型进行股票预测
model = LSTMModel(d_feat=158, n_epochs=100)
model.fit(X_train, y_train, X_valid, y_valid)
predictions = model.predict(X_test)
```

### 场景3: 量化策略回测
```python
# 基于模型预测进行策略回测
engine = BacktestEngine(data, predictions, top_k=20)
result = engine.run()
# 获取夏普比率、最大回撤等关键指标
```

## 📈 项目成熟度评估

### ✅ 已完成的核心功能
- [x] **完整的数据处理流水线**
- [x] **158个Alpha因子的完整实现**
- [x] **三种深度学习模型的全面支持**
- [x] **企业级的MCP服务集成**
- [x] **专业的回测引擎**
- [x] **完善的文档和示例**

### 🚀 技术创新点
1. **参考Qlib的企业级架构设计**
2. **Alpha158因子库的完整本地化实现**
3. **深度学习三剑客的集成应用**
4. **灵活的Processor数据预处理系统**
5. **无缝的Roo-Code生态集成**

## 🔮 未来发展方向

### 短期规划 (1-2个月)
- [ ] 更多传统机器学习模型集成
- [ ] 实时数据流处理能力
- [ ] 高级风险管理模块
- [ ] 更多回测策略支持

### 中期规划 (3-6个月)
- [ ] 分布式计算支持
- [ ] 云原生部署方案
- [ ] 高级可视化仪表板
- [ ] API服务化改造

### 长期规划 (6-12个月)
- [ ] 多资产类别支持（期货、期权、加密货币）
- [ ] 高频交易策略支持
- [ ] 强化学习模型集成
- [ ] 国际化市场支持

---

**🏢 aigroup-quant-mcp** 是一个成熟的企业级量化金融分析平台，具备完整的技术栈、丰富的功能特性和良好的扩展性，为量化研究人员和机构投资者提供了专业、可靠、高效的解决方案。