# æ•°æ®åˆå¹¶åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªè®¾è®¡é™åˆ¶ï¼š

- `train_ml_model` å·¥å…·éœ€è¦æ•°æ®åŒ…å« `close` åˆ—æ¥ç”Ÿæˆé¢„æµ‹æ ‡ç­¾
- `generate_alpha158` ç”Ÿæˆçš„å› å­æ•°æ®**ä¸åŒ…å«** `close` åˆ—
- å¯¼è‡´æ— æ³•ç›´æ¥ä½¿ç”¨Alpha158å› å­è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹

## âœ¨ è§£å†³æ–¹æ¡ˆï¼šmerge_factor_data

æ–°å¢çš„ `merge_factor_data` å·¥å…·å¯ä»¥å°†å› å­æ•°æ®å’Œä»·æ ¼æ•°æ®åˆå¹¶ï¼Œç”ŸæˆåŒ…å«æ‰€æœ‰å› å­åˆ—å’Œcloseåˆ—çš„å®Œæ•´æ•°æ®é›†ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### åŠŸèƒ½ç‰¹ç‚¹

âœ… **æ™ºèƒ½åˆå¹¶**ï¼šè‡ªåŠ¨å¯¹é½å› å­æ•°æ®å’Œä»·æ ¼æ•°æ®çš„ç´¢å¼•  
âœ… **æ•°æ®éªŒè¯**ï¼šç¡®ä¿ä¸¤ä¸ªæ•°æ®é›†æœ‰æ—¶é—´é‡å   
âœ… **çµæ´»å¯¼å‡º**ï¼šæ”¯æŒCSVå’ŒJSONæ ¼å¼å¯¼å‡º  
âœ… **å®Œæ•´å…¼å®¹**ï¼šåˆå¹¶åçš„æ•°æ®å¯ç›´æ¥ç”¨äº `train_ml_model`

### å·¥ä½œåŸç†

```
å› å­æ•°æ® (159ä¸ªå› å­åˆ—)  +  ä»·æ ¼æ•°æ® (closeåˆ—)
         â†“                          â†“
    [ç´¢å¼•å¯¹é½ + åˆå¹¶]
         â†“
åˆå¹¶æ•°æ® (159ä¸ªå› å­åˆ— + 1ä¸ªcloseåˆ—)
```

## ğŸ“– ä½¿ç”¨æµç¨‹

### å®Œæ•´å·¥ä½œæµç¨‹

```
1ï¸âƒ£ preprocess_data
   â””â”€ åŠ è½½å¹¶æ¸…æ´—åŸå§‹ä»·æ ¼æ•°æ®
       â†“
2ï¸âƒ£ generate_alpha158
   â””â”€ ç”ŸæˆAlpha158å› å­ï¼ˆ159ä¸ªå› å­ï¼‰
       â†“
3ï¸âƒ£ apply_processor_chain (å¯é€‰)
   â””â”€ æ ‡å‡†åŒ–å› å­æ•°æ®
       â†“
4ï¸âƒ£ merge_factor_data ğŸ‘ˆ æ–°å¢æ­¥éª¤
   â””â”€ åˆå¹¶å› å­æ•°æ®å’Œä»·æ ¼æ•°æ®
       â†“
5ï¸âƒ£ train_ml_model
   â””â”€ è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹
       â†“
6ï¸âƒ£ predict_ml_model
   â””â”€ ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåŸºç¡€ä½¿ç”¨ï¼ˆæœ€ç®€å•ï¼‰

```json
{
  "factor_data_id": "alpha158_normalized",
  "price_data_id": "stock_data_2023",
  "result_id": "merged_alpha158"
}
```

**è¯´æ˜**ï¼š
- `factor_data_id`: å·²ç”Ÿæˆçš„å› å­æ•°æ®ï¼ˆé€šå¸¸æ˜¯generate_alpha158æˆ–apply_processor_chainçš„è¾“å‡ºï¼‰
- `price_data_id`: åŸå§‹ä»·æ ¼æ•°æ®ï¼ˆå¿…é¡»åŒ…å«closeåˆ—ï¼‰
- `result_id`: åˆå¹¶åæ•°æ®çš„å”¯ä¸€æ ‡è¯†

### ç¤ºä¾‹2ï¼šåˆå¹¶å¹¶å¯¼å‡ºCSV

```json
{
  "factor_data_id": "alpha158_stock",
  "price_data_id": "raw_data",
  "result_id": "alpha158_with_price",
  "export_path": "./exports/merged_data.csv",
  "export_format": "csv"
}
```

**ä¼˜åŠ¿**ï¼š
- å¯¼å‡ºåå¯åœ¨Excelä¸­æŸ¥çœ‹éªŒè¯
- ä¾¿äºæ•°æ®è´¨é‡æ£€æŸ¥
- æ”¯æŒå¤–éƒ¨å·¥å…·åˆ†æ

### ç¤ºä¾‹3ï¼šå®Œæ•´æµç¨‹ç¤ºä¾‹

```python
# æ­¥éª¤1: åŠ è½½åŸå§‹æ•°æ®
{
  "file_path": "D:/data/stock_2023.csv",
  "data_id": "stock_2023",
  "auto_clean": true
}

# æ­¥éª¤2: ç”ŸæˆAlpha158å› å­
{
  "data_id": "stock_2023",
  "result_id": "alpha158_raw",
  "kbar": true,
  "price": true,
  "volume": true,
  "rolling": true
}

# æ­¥éª¤3: æ ‡å‡†åŒ–å› å­ï¼ˆå¯é€‰ä½†æ¨èï¼‰
{
  "data_id": "alpha158_raw",
  "result_id": "alpha158_normalized",
  "processors": [
    {"name": "CSZScoreNorm"}
  ]
}

# æ­¥éª¤4: åˆå¹¶å› å­å’Œä»·æ ¼ â­ å…³é”®æ­¥éª¤
{
  "factor_data_id": "alpha158_normalized",
  "price_data_id": "stock_2023",
  "result_id": "merged_for_training"
}

# æ­¥éª¤5: è®­ç»ƒæ¨¡å‹
{
  "data_id": "merged_for_training",
  "model_id": "lgb_model_v1",
  "model_type": "lightgbm",
  "train_start": "2023-01-01",
  "train_end": "2023-06-30",
  "test_start": "2023-07-01",
  "test_end": "2023-12-31"
}
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦åˆå¹¶æ•°æ®ï¼Ÿ

**A**: `train_ml_model` éœ€è¦ `close` åˆ—æ¥ç”Ÿæˆé¢„æµ‹æ ‡ç­¾ï¼ˆæœªæ¥æ”¶ç›Šç‡ï¼‰ï¼Œä½†å› å­æ•°æ®ä¸­æ²¡æœ‰è¿™ä¸€åˆ—ã€‚åˆå¹¶åçš„æ•°æ®åŒ…å«ï¼š
- å› å­åˆ—ï¼ˆç”¨ä½œç‰¹å¾ï¼‰
- closeåˆ—ï¼ˆç”¨äºç”Ÿæˆæ ‡ç­¾ï¼‰

### Q2: åˆå¹¶æ—¶æç¤º"ç´¢å¼•æ²¡æœ‰é‡å "æ€ä¹ˆåŠï¼Ÿ

**A**: ç¡®ä¿å› å­æ•°æ®å’Œä»·æ ¼æ•°æ®æ¥æºäºåŒä¸€ä¸ªåŸå§‹æ•°æ®ï¼š
```json
// âœ… æ­£ç¡®åšæ³•
preprocess_data â†’ data_id: "stock_2023"
generate_alpha158 â†’ data_id: "stock_2023", result_id: "factors"
merge_factor_data â†’ factor_data_id: "factors", price_data_id: "stock_2023"

// âŒ é”™è¯¯åšæ³•
// ä½¿ç”¨äº†ä¸¤ä¸ªä¸åŒçš„åŸå§‹æ•°æ®æº
```

### Q3: å¿…é¡»å…ˆæ ‡å‡†åŒ–å› å­å—ï¼Ÿ

**A**: ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†**å¼ºçƒˆæ¨è**ï¼š
- æ ‡å‡†åŒ–åçš„å› å­è®­ç»ƒæ•ˆæœæ›´å¥½
- é¿å…ä¸åŒé‡çº²çš„å› å­æƒé‡å¤±è¡¡
- æ¨èä½¿ç”¨ `apply_processor_chain` + `CSZScoreNorm`

### Q4: å¯ä»¥åˆå¹¶è‡ªå®šä¹‰å› å­å—ï¼Ÿ

**A**: å¯ä»¥ï¼åªè¦å› å­æ•°æ®æ˜¯DataFrameæ ¼å¼ï¼Œéƒ½å¯ä»¥ä½¿ç”¨merge_factor_dataï¼š
```json
{
  "factor_data_id": "my_custom_factors",  // è‡ªå®šä¹‰å› å­
  "price_data_id": "stock_2023",
  "result_id": "merged_custom_factors"
}
```

## ğŸ“Š æ•°æ®ç»“æ„è¯´æ˜

### åˆå¹¶å‰

**å› å­æ•°æ®** (alpha158_normalized):
```
Index: MultiIndex(datetime, symbol)
Columns: [KMID, KLEN, KMID2, ..., VSTD60]  # 159ä¸ªå› å­åˆ—
```

**ä»·æ ¼æ•°æ®** (stock_2023):
```
Index: MultiIndex(datetime, symbol)
Columns: [open, high, low, close, volume, ...]
```

### åˆå¹¶å

**åˆå¹¶æ•°æ®** (merged_for_training):
```
Index: MultiIndex(datetime, symbol)
Columns: [KMID, KLEN, ..., VSTD60, close]  # 159å› å­ + 1ä»·æ ¼
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### å¯¼å‡ºä¸åŒæ ¼å¼

```json
// CSVæ ¼å¼ - ä¾¿äºExcelæŸ¥çœ‹
{
  "export_path": "./exports/merged.csv",
  "export_format": "csv"
}

// JSONæ ¼å¼ - ä¾¿äºç¨‹åºå¤„ç†
{
  "export_path": "./exports/merged.json",
  "export_format": "json"
}
```

### æŸ¥çœ‹å¯ç”¨æ•°æ®

ä½¿ç”¨ `list_factors` å·¥å…·æŸ¥çœ‹å½“å‰å†…å­˜ä¸­æ‰€æœ‰å¯ç”¨çš„æ•°æ®å’Œå› å­ï¼š

```json
{}  // æ— éœ€å‚æ•°
```

è¿”å›ç¤ºä¾‹ï¼š
```json
{
  "data_count": 1,
  "data_ids": ["stock_2023"],
  "factor_count": 3,
  "factors": {
    "alpha158_raw": {"type": "DataFrame", "shape": [10000, 159]},
    "alpha158_normalized": {"type": "DataFrame", "shape": [10000, 159]},
    "merged_for_training": {"type": "DataFrame", "shape": [10000, 160]}
  }
}
```

## ğŸ“ˆ æ€§èƒ½è¯´æ˜

| æ•°æ®é‡ | é¢„è®¡è€—æ—¶ |
|--------|----------|
| < 10ä¸‡è¡Œ | < 1ç§’ |
| 10-100ä¸‡è¡Œ | 1-5ç§’ |
| > 100ä¸‡è¡Œ | 5-15ç§’ |

## ğŸ“ æœ€ä½³å®è·µ

1. **æ•°æ®æ¥æºä¸€è‡´**ï¼šç¡®ä¿å› å­å’Œä»·æ ¼æ¥è‡ªåŒä¸€åŸå§‹æ•°æ®
2. **å…ˆæ ‡å‡†åŒ–å†åˆå¹¶**ï¼šè·å¾—æ›´å¥½çš„æ¨¡å‹æ•ˆæœ
3. **å¯¼å‡ºéªŒè¯**ï¼šåˆå¹¶åå¯¼å‡ºCSVæ£€æŸ¥æ•°æ®è´¨é‡
4. **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æè¿°æ€§çš„result_idä¾¿äºç®¡ç†
5. **å·¥ä½œæµé¡ºåº**ï¼šä¸¥æ ¼æŒ‰ç…§æ¨èå·¥ä½œæµæ‰§è¡Œ

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°

### v1.0.24 æ–°å¢åŠŸèƒ½
- âœ¨ æ–°å¢ `merge_factor_data` å·¥å…·
- ğŸ”§ è§£å†³å› å­æ•°æ®æ— æ³•ç›´æ¥è®­ç»ƒæ¨¡å‹çš„é—®é¢˜
- ğŸ“ å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ML_MODELS_GUIDE.md](./ML_MODELS_GUIDE.md) - æœºå™¨å­¦ä¹ æ¨¡å‹ä½¿ç”¨æŒ‡å—
- [README.md](../README.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [CHANGELOG.md](../CHANGELOG.md) - ç‰ˆæœ¬æ›´æ–°è®°å½•

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®IDæ˜¯å¦æ­£ç¡®ï¼ˆä½¿ç”¨list_factorsæŸ¥çœ‹ï¼‰
2. ä¸¤ä¸ªæ•°æ®é›†çš„æ—¶é—´èŒƒå›´æ˜¯å¦æœ‰é‡å 
3. å› å­æ•°æ®æ˜¯å¦å·²æ­£ç¡®ç”Ÿæˆ
4. ä»·æ ¼æ•°æ®æ˜¯å¦åŒ…å«closeåˆ—

---

ğŸ“§ å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿æIssueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚